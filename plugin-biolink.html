<template id="biolink">
    <div>
        <a class="kiwi-userbox-action" v-if="user.account" @click="openBio()">
            <i aria-hidden="true" class="fa fa-question-circle"></i>
            Bio Link
        </a>
    </div>
</template>

<template id="bioframe">
    <div class="biolink">
		<div class="bioheader">
			<div class="bioclose" @click="closeBio()">Close Biolink</div>
			<div v-if="isSelf()" class="biounset" @click="biounSet()">Remove Biolink</div>
		</div>
        <iframe :src="biolinks"></iframe>
		
    </div>
</template>

<template id="nobio">
    <div class="biolink">
        <div class="bioclose" @click="closeBio()">Close Biolink</div>
		
        <div class="nobio-content">
            Biolink not set
            <div v-if="isSelf()">


            <div class="u-input-text">
                <div class="u-input-text-inputs">
                    <input class="u-input biolink-input" placeholder="bio.link URL" type="text" v-model="biolinkInput" style="color: var(--brand-default-fg);padding: 0.4em 0.9em;">
                </div>
            </div>
            <div class="u-input-text-underline">
                <div class="u-input-text-underline-active"></div>
            </div>
            <button :class="['u-button', 'u-button-primary', 'u-submit', 'kiwi-welcome-simple-start']" v-on:click="bioSet" >Set Bio.link</button>



				<p>
					Using <a href="https://bio.link" target="_blank">bio.link</a> lets you link to all your pages - websites, social posts, videos, music, bio, photo - making it easier for your audience to discover all your content.
				</p>
				<p>
					Do you want to insert a Dogecoin tipping jar in your bio? <br>
					Find out how at <a href="https://www.timysite.com" target="_blank">TypMySite</a>
				</p>
			</div>
            <div v-if="!isSelf()">
				<p>
					Discover <a href="https://bio.link" target="_blank">bio.link</a>, an easy way to enrich your profile with websites, social posts, videos, music, bio, photo and much more.
				</p>
				<p>
					Only registered users can setup a bio.link
				</p>
			</div>
            <p style="text-align:center">
                <a target="_blank" aria-label="Biolink" rel="noopener nofollow" href="https://bio.link">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path class="bl-logo-br" opacity="0.5" fill-rule="evenodd" clip-rule="evenodd" d="M0 0.390244C0 0.174718 0.174718 0 0.390244 0H31.6098C31.8253 0 32 0.174718 32 0.390244V31.6098C32 31.8253 31.8253 32 31.6098 32H0.390244C0.174718 32 0 31.8253 0 31.6098V0.390244ZM0.780488 0.780488V31.2195H31.2195V0.780488H0.780488ZM8.89232 9.48226V7.81313C8.89232 7.57935 8.76608 7.46247 8.51361 7.46247H7.36345V9.83291H8.51361C8.76608 9.83291 8.89232 9.71603 8.89232 9.48226ZM8.89232 13.2834V11.5441C8.89232 11.4226 8.86427 11.3384 8.80816 11.2916C8.75206 11.2355 8.65387 11.2075 8.51361 11.2075H7.36345V13.634H8.51361C8.76608 13.634 8.89232 13.5172 8.89232 13.2834ZM5.38574 6.08789H9.08869C10.2762 6.08789 10.87 6.60219 10.87 7.63078V9.20173C10.87 9.89369 10.6596 10.3285 10.2388 10.5062C10.6596 10.6651 10.87 11.0672 10.87 11.7124V13.4517C10.87 14.4896 10.2762 15.0086 9.08869 15.0086H5.38574V6.08789ZM12.0985 6.08789H14.0903V15.0086H12.0985V6.08789ZM19.0034 6.08789H17.1239C15.9363 6.08789 15.3426 6.60219 15.3426 7.63078V13.4517C15.3426 14.4896 15.9363 15.0086 17.1239 15.0086H19.0034C20.1816 15.0086 20.7707 14.4896 20.7707 13.4517V7.63078C20.7707 6.60219 20.1816 6.08789 19.0034 6.08789ZM18.765 7.91131V13.1852C18.765 13.419 18.6434 13.5359 18.4003 13.5359H17.727C17.4746 13.5359 17.3483 13.419 17.3483 13.1852V7.91131C17.3483 7.67754 17.4746 7.56065 17.727 7.56065H18.4003C18.6434 7.56065 18.765 7.67754 18.765 7.91131ZM9.95113 24.4704H7.38431V17.0225H5.39258V25.9432H9.95113V24.4704ZM12.6315 17.0225H10.6397V25.9432H12.6315V17.0225ZM17.6709 17.0225H19.5083V25.9432H17.7129L15.7633 20.5992V25.9432H13.9399V17.0225H15.7492L17.6709 22.3525V17.0225ZM24.885 21.4267L26.6803 17.0225H24.5203L22.7951 21.4267L24.5203 25.9432H26.6803L24.885 21.4267ZM20.7612 17.0225V25.9432H22.753V17.0225H20.7612ZM22.0195 13.7761C22.0195 14.4442 22.5612 14.9858 23.2293 14.9858C23.8974 14.9858 24.439 14.4442 24.439 13.7761V13.698C24.439 13.0299 23.8974 12.4883 23.2293 12.4883C22.5612 12.4883 22.0195 13.0299 22.0195 13.698V13.7761Z" fill="#ffffff"></path>
                    </svg>
                </a>
            </p>
        </div>
    </div>
</template>

<script>
    kiwi.plugin('biolink', function (kiwi, log) {
        let bioFrame = kiwi.Vue.extend({
            props: ['user', 'biolinks', 'network'],
            template: '#bioframe',
            data() {
                return {
					account: this.user.account,
                    biolinks: this.biolinks,
                };
            },
            methods: {
                closeBio() {
                    kiwi.emit('userbox.show', this.user);
                },
                isSelf() {
                    return this.user === this.network.currentUser();
                },
				biounSet() {
					kiwi.state.$emit('input.raw', '/NS SET BIOLINK');
					kiwi.emit('userbox.show', this.user);
				},	
            },
        });


        let noBio = kiwi.Vue.extend({
            props: ['user', 'network'],
            template: '#nobio',
            data() {
                return {
					biolinkInput: '',
				};
            },
            methods: {
                closeBio() {
                    kiwi.emit('userbox.show', this.user);
                },
                isSelf() {
                    return this.user === this.network.currentUser();
                },
				bioSet: function () {
					if ((this.biolinkInput !== '') && (this.biolinkInput.startsWith('https://bio.link/'))) {
						kiwi.state.$emit('input.raw', '/NS SET BIOLINK '+ this.biolinkInput );
						kiwi.emit('userbox.show', this.user);
					} else {
						alert('Wrong Format, please insert a valid bio.link URL');
					}
				},
            },
        });


        let biolink = kiwi.Vue.extend({
            props: ['user','network'],
            template: '#biolink',
            data() {
                return {};
            },
            methods: {
                openBio: function openBio() {
                    let biolinks = '';
					let user = this.user;
					let network = this.network;
					//console.log('network: ', network);
                    const xhr = new XMLHttpRequest();
                    xhr.open('GET', 'https://www.simosnap.org/rest/service.php/nmisc/' + this.user.account);
                    xhr.responseType = 'json';
                    xhr.onload = function(e) {
                      if (this.status == 200) {
                        //console.log('response', this.response['BIOLINK']); // JSON response
                        biolinks = this.response['BIOLINK'];
                        if ((biolinks) && (biolinks.startsWith('https://bio.link/'))) {
                            kiwi.showInSidebar(bioFrame, { user: user, biolinks: biolinks, network: network  });
                        } else {
                            kiwi.showInSidebar(noBio, { user: user, network: network });
                        }
                      } else {
                         kiwi.showInSidebar(noBio, { user: this.user, network: network }); 
                      }
                    };
                    xhr.send();

                },
            },
        });

        kiwi.addUi('userbox_button', biolink); 
    });
</script>
<style>

	.kiwi-userbox-plugin-actions {
		display:flex;
		flex-direction: column !important;
		justify-content: center;
		padding:0.5em;
		padding-bottom:0;
	}

	.kiwi-userbox-plugin-actions div {
		margin: 0 auto;
		width: 100%
	}

	.kiwi-userbox-plugin-actions div > a , .kiwi-userbox-plugin-actions div > form , .kiwi-userbox-ignoreuser {
		max-width: 218px;
		display: block;
		margin:0 auto !important;
	}

	.kiwi-userbox-plugin-actions div > form {
		margin-top:0.5em;
		padding:0.5em;
	}

	.callerid-userbox-form {
		margin-top: 1em !important;
	}

	.kiwi-user-callerid-label {
		margin: 0px !important;
	}

	.kiwi-userbox-ignoreuser span {
		float: none;
	}

	.biolink-input {
		
	}
    .biolink {
        position: absolute;
        top: 0;
        right: 0;
        left: 0;
        bottom: 0;
        z-index: 9999999;
    }

    .biolink iframe {
        width: 100%;
        height: 100%;
        border: none;
        border-width: 0;
        margin: 0px;
        padding: 0px;
        background: #222;
        zoom: 0.85;
    }
    
	.bioheader {
		display:flex;
		justify-content:space-between;
		background: #222;
	}
    .bioclose {
        background: #222;
        color: white;
        text-decoration: underline;
        padding:5px;
		cursor: pointer;
        
    }
	.biounset {
        background: #222;
        color: white;
        text-decoration: underline;
        padding:5px;
		cursor: pointer;
    }
    .nobio-content {
        background: #222;
        color: white;
        padding:5px;
        height:100%;
    }
    .nobio-content p {
		line-height: auto;
    }

	.nobio-content a {
		color: var(--brand-link-normal);
	}

	@media screen and (max-width: 769px) {

		.kiwi-userbox-plugin-actions { 
			padding-right:0px;
			padding-left:0px;
		}
		.kiwi-userbox-plugin-actions div > a {
			max-width: 100%;
			
		}
	}
</style>
